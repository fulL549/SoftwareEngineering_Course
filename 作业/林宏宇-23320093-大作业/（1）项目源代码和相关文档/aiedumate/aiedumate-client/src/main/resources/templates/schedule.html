<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的课程表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .schedule-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .schedule-header {
            text-align: center;
            margin-bottom: 20px;
            color: #1976d2;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
        }
        .schedule-table th {
            background-color: #1976d2;
            color: white;
            font-weight: 500;
        }
        .schedule-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .time-col {
            background-color: #e9ecef;
            font-weight: 500;
            width: 10%;
        }
        .course-cell {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .course-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        .course-info {
            font-size: 0.9em;
            color: #6c757d;
        }
        .current-course {
            background-color: #e3f2fd;
            position: relative;
        }
        .current-course::after {
            content: "当前课程";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7em;
            background-color: #1976d2;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }
        .period-header {
            background-color: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="schedule-container">
    <div id="loadingIndicator" class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p>正在加载课程表...</p>
    </div>

    <div id="errorDisplay" class="error-message" style="display: none;"></div>

    <div id="scheduleContent" style="display: none;">
        <div class="table-responsive">
            <table class="schedule-table" id="scheduleTable">
                <thead>
                <tr>
                    <th>时间段</th>
                    <th>星期一</th>
                    <th>星期二</th>
                    <th>星期三</th>
                    <th>星期四</th>
                    <th>星期五</th>
                    <th>星期六</th>
                    <th>星期日</th>
                </tr>
                </thead>
                <tbody id="scheduleBody">
                <!-- 课程表内容将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 页面加载完成后获取课程表数据
    document.addEventListener('DOMContentLoaded', function() {
        fetchScheduleData();
    });

    // 从后端获取课程表数据
    function fetchScheduleData() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const scheduleContent = document.getElementById('scheduleContent');

        // 显示加载状态
        loadingIndicator.style.display = 'block';
        errorDisplay.style.display = 'none';
        scheduleContent.style.display = 'none';

        let token = localStorage.getItem('jwtToken');
        // 实际应用中替换为真实的API调用
        fetch('/api/schedule', {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            }
        )
        .then(response => {
            console.log('response:', response);
            if (!response.ok) {
                // 根据状态码抛出不同错误
                if (response.status === 401) {
                    throw new Error('登录已过期，请重新登录');
                } else if (response.status === 500) {
                    throw new Error('服务器内部错误');
                } else {
                    throw new Error(`请求失败: ${response.status}`);
                }
            }
            return response.json();
        })
        .then(data => {
            console.log('data:', data);
            renderSchedule(data);
        })
        .catch(error => showError(error.message));
    }

    // 渲染课程表
    function renderSchedule(data) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const scheduleContent = document.getElementById('scheduleContent');
        const scheduleBody = document.getElementById('scheduleBody');

        // 隐藏加载状态和错误信息，显示内容
        loadingIndicator.style.display = 'none';
        errorDisplay.style.display = 'none';
        scheduleContent.style.display = 'block';

        // 清空现有课程表内容
        scheduleBody.innerHTML = '';

        // 获取当前时间（用于标记当前课程）
        const now = new Date();
        const currentDay = now.getDay(); // 0是周日，1是周一，...，6是周六
        const currentHours = now.getHours();

        // 定义时间段
        const timePeriods = [
            { name: "上午" , startHour: 6, endHour: 12},
            { name: "下午" , startHour: 12, endHour: 18},
            { name: "晚上" , startHour: 18, endHour: 24}
        ];
        // 定义星期
        const dayOfWeekList = [
            { name: "星期一" , day: 1},
            { name: "星期二" , day: 2},
            { name: "星期三" , day: 3},
            { name: "星期四" , day: 4},
            { name: "星期五" , day: 5},
            { name: "星期六" , day: 6},
            { name: "星期日" , day: 0}
        ];
        // 创建时间段行
        timePeriods.forEach(period => {
            const row = document.createElement('tr');

            // 添加时间段列
            const timeCell = document.createElement('td');
            timeCell.className = 'time-col';
            timeCell.textContent = period.name;
            row.appendChild(timeCell);

            // 为每一天添加课程单元格
            dayOfWeekList.forEach (week => {
                const cell = document.createElement('td');
                const courses = data.filter(c =>
                    c.dayOfWeek === week.name &&
                    c.timeSlot === period.name
                );

                if (courses.length > 0) {
                    // 检查是否是当前课程
                    const isCurrentCourse = (
                        currentDay === (week.day % 7)  && // 0是周日，1是周一...
                        currentHours >= period.startHour &&
                        currentHours < period.endHour
                    );

                    if (isCurrentCourse) {
                        cell.classList.add('current-course');
                    }

                    const courseDiv = document.createElement('div');
                    courseDiv.className = 'course-cell';

                    courses.forEach(course => {
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'course-name';
                        nameDiv.textContent = course.course;

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'course-info';
                        if (course.teacher === null){
                            course.teacher = '';
                        }
                        if (course.classroom === null){
                            course.classroom = '';
                        }
                        infoDiv.innerHTML = `
                            ${course.teacher}  ${course.classroom}<br>
                            ${course.startTime}-${course.endTime}
                        `;

                        courseDiv.appendChild(nameDiv);
                        courseDiv.appendChild(infoDiv);
                    });

                    cell.appendChild(courseDiv);
                }

                row.appendChild(cell);
            });

            scheduleBody.appendChild(row);
        });
    }

    // 显示错误信息
    function showError(message) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const scheduleContent = document.getElementById('scheduleContent');

        loadingIndicator.style.display = 'none';
        scheduleContent.style.display = 'none';
        errorDisplay.style.display = 'block';
        errorDisplay.textContent = message;
    }
</script>
</body>
</html>